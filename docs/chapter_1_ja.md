レポジトリ管理
=================================
モバイル端末は他の商用電源を使用するコンピューターと違い、バッテリを使用します、したかって随時にバッテリ残量の問題でシステムシャットダウンが発生する可能性があり、または他のシステムイベント（例えば電話着信など）によって中断される可能性があります。一方ユーザーのデータ保全は極めて重要のため、我々は設計時に特別にこのことを考慮してあります。

すべてのレポジトリへの書き込み処理は原子的である。つまり、捜査が中断または失敗しても、レポジトリが前の状態にロールバックされます。データに悪影響を与えることはありません。

レポジトリの管理は　***すべてのレポジトリ*** ビューで行います。 ***サイドメニュー --> すべてのレポジトリ*** にあります。

レポジトリを新規作成
---------
#### 空のレポジトリを作成する
***レポジトリ作成*** ボタンをクリックすることで、レポジトリ作成ビューを開きます。レポジトリ名を入力して ***完了*** をクリックすれば完成です。この方法で作成されたレポジトリのiCloud自動同期はデフォルトでONとなります。同レポジトリに対するすべての更新が自動的にiCloudへ同期されます。

#### リモートレポジトリをクローンする
この機能でレモートサーバー上のレポジトリをクローンする。 ***レポジトリクローン*** ボタンをクリックしてレポジトリクローンビューを開きます。レポジトリのURLを入力したあと、　***完了*** をクリックします。この方法で作成されたレポジトリのiCloud自動同期はデフォルトでONとなります。同レポジトリに対するすべての更新が自動的にiCloudへ同期されます。

リモートレポジトリのダウンロードにユーザー認証が必要な場合、ダウンロードを続くには、ユーザー名とログインしてください。

***サタスクビュー(サイドメニュー --> タスク)*** からは、随時レポジトリクローンの進捗を確認したり、未完了のレポジトリクローンをキャンセルすることができます。

#### GitHubからダウンロードする
上記の方法以外に、App内でGitHub上のレポジトリに対する検索も対応しています。したがい、App内で直接GitHubのレポジトリをダウンロードすることも可能です。GitHubからダウンロードしたレポジトリのiCloud自動同期はデフォルトでONとなります。自動同期を利用するには、同機能をONにしてください。

デフォルトでは、レポジトリのダウンロードは端末がホーム画面に戻る場合、または他のAppを起動した場合に中断されます。ただし ***サーバー設定（サイドメニュー --> 設定 --> サーバー）*** でバックグラウンド実行モードを有効にした場合、ダウンロードは最後まで続きます。

モバイル端末の処理能力に限界があり、同時に多数のダウンロードを行うとシステムリソースを大量に消費するため、GitDriveが強制終了されることがあります。よって、一度同時に多数のダウンロードを行わないことをおすすめします。

レポジトリの削除
---------
レポジトリビューで画面右上の ***編集*** ボタンをクリックすると、リストが編集状態に切り替わります。削除したいレポジトリの右側に表示される灰色の「削除」ボタンをクリックしてください。削除処理はiCloudに同期割れたレポジトリも同様に削除し、かつ削除処理は取り消すことができないため、削除を行う前に、慎重に確認してください。

一方、現在の端末で削除するレポジトリがすでに他の端末に同期された場合、他の端末上では削除されることがありません。同時に、その端末で該当レポジトリの自動クラウド同期機能の無効化されます。

レポジトリの設定
---------
レポジトリビューで画面右上の ***編集*** ボタンをクリックすると、リストが編集状態に切り替わります。設定したいレポジトリの右側に表示される灰色の「設定」ボタンをクリックしてください。ここではレポジトリに対して以下の設定が可能です：
- レポジトリ名称
- 自動クラウド同期
- レポジトリに対するshallow更新許可
-　外部アクセス許可
- レポジトリアクセスユーザー認証

#### 自動クラウド同期
この機能を有効にすると、レポジトリのすべての更新が自動的にiCloudへ同期されます。この機能を無効にすると、iCloudに同期されたコピーも削除されます。

#### レポジトリに対するshallow更新許可
ローカルのレポジトリがshallow以外の方式でクローンされた場合、shallow更新の処理に関わることがありません。ローカルレポジトリをクリーンする際に引数 ***--depth*** を使用した場合、レポジトリがshallowとなることがあります。この場合、同レポジトリをGitDriveへPushする際にshallow更新処理が発生します。デフォルトではshallow更新を許可します

#### 外部アクセス許可
この機能を無効にすると、モバイル端末外部からレポジトリへのアクセスが不可能となります。

#### レポジトリアクセスユーザー認証
この機能を有効にすると、レポジトリに対するレモートアクセスはユーザー名とパスワードによる認証が必要になります。

該当のレポジトリに対して、 ***ユーザー管理*** でユーザーに対してアクセス権限を付与する必要があります。アクセス権限を持つユーザーが存在しない場合、該当のレポジトリがモバイル端末外部からのアクセスが一切不可となります。レポジトリアクセスユーザー認証を有効し、下部の ***ユーザー管理*** でアクセス権限を付与するユーザーを選択します。

クラウド同期
---------
iCloudをGitDriveのクラウドストレージとして利用することができます。iCloudを利用することによって、レポジトリの更新をお持ちのすべての端末に同期することが可能です、万が一の端末の破損によるデーター紛失を避けるために、重要なレポジトリに対してクラウド同期機能を有効にすることをおすすめします。

レポジトリのクラウド同期が有効にされた場合、GitDriveは定期的にレポジトリの更新をiCloud、およびお持ちのすべての端末へ同期します。同期はインクリメントとなり、最小なデータ転送量を使います。

一方、レポジトリとクラウド上のレポジトリでコンフリクトが起きることがあります。例えば以下の場合：端末AのレポジトリCは一部の更新がまだクラウドへ同期されず、同時に端末BのレポジトリCも同様にクラウドへ同期されていない更新がある。この2つの端末が同時に同期を行うと、コンフリクトが置きます。ならば、コンフリクトをどうやって解決するでしょうか。端末Aとしては、端末Bからの更新でコンフリクトが起きた場合、自動的なコンフリクト解決を試みます。コンフリクトのある内容は、レポジトリCへ保存されるではなく、新たなレポジトリC_xxxxxとして保存されます。この場合Cはメインレポジトリ、C_xxxxはサブレポジトリと呼びます。C_xxxxでは端末Bからの更新内容を保存します。

また、レポジトリのコンフリクトを手動で解決したい場合、メインレポジトリとサブレポジトリ両方ともローカルへダウンロードして、ローカルでこの2つのレポジトリのコンフリクトを解消（マージ）したレポジトリを新規作成することで、GitDriveの旧メインレポジトリを削除し、代わりに新規作成してレポジトリをGitDriveにアップロードすることで解決できます。

一つのレメインポジトリは複数のサブレポジトリを持つことがあります。サブレポジトリは単独で削除することができず、メインレポジトリの削除と同時に削除されます。サブレポジトリの更新は、同様にクラウドへ同期されます。

レポジトリのアイコンについて
---------
レポジトリビューでは、レポジトリ名称のい横にアイコンが表示されます。それぞれのアイコンは異なる意味を持ちます。その意味を理解することで、レポジトリの管理に役に立ちます。以下はアイコンの意味を説明します：
- ![](../image/icon_indicator_repository_new.png) 新しいレポジトリです。レポジトリ名称をクリックすると、このアイコンが消えます。
- ![](../image/icon_indicator_repository_auth.png) レポジトリアクセスユーザー認証が有効されています。リモートアクセス時はユーザー名とパスワードが求められます。
- ![](../image/icon_indicator_repository_shallow.png) shallowのレポジトリです。
- ![](../image/icon_indicator_repository_locked.png) 該当のレポジトリがロックされています。ロック状態のレポジトリに対しては書き込み操作ができません。
- ![](../image/icon_indicator_repository_need_backup.png) 該当のレポジトリで一部の更新がまだクラウドへ同期されていません。クラウドへ同期されない原因は様々あります。例えば：Wi-Fi環境のみ同期すると設定されたが、現在のネットワーク状態がそれを満たしていない場合、または、iCLoudへログインしていない場合など。
- ![](../image/icon_indicator_repository_new_content.png) 該当のレポジトリが最近更新されていますが、更新内容を確認していません。中の数字は、未確認の更新の件数を示します。
- ![](../image/icon_indicator_repository_root.png) 該当のレポジトリとiCloud上のレポジトリでコンフリクトが起きており、メインレポジトリです。
- ![](../image/icon_indicator_repository_child.png) 該当のレポジトリとiCloud上のレポジトリでコンフリクトが起きており、それを解決するために自動的に作成されたサブレポジトリです。メインレポジトリとコンフリクトした内容が保存されています。

レポジトリのロックについて
---------
操作の原子性を維持するために、Appはレポジトリに対するあらゆる操作を行う前にレポジトリをロック状態にし、操作成功後にロックを解除しています。操作が失敗した場合はレポジトリが前の状態にロールバックします。しかし稀なケースでは、ロールバックが失敗することがあります（例：ストレージが一杯）。この場合、レポジトリはロックの状態のままとなります。この状態ではレポジトリに対するあらゆる書き込み操作はできず、レポジトリは読み取り専用となります。

この場合は手動でロックを解除する必要があります。手順はとても簡単で、ロックされたレポジトリをローカルへダウンロードした後、同レポジトリを削除します。そして先程ダウンロードしたレポジトリを再度アップロードするだけです。
