仓库管理
=================================
由于移动设备不同于其它使用电源的计算设备，它使用电池，所以随时都可能由于电量问题导致系统关闭，或者被其它系统事件打断，例如打进的电话，或者其他等等，所以我们在设计上格外的考虑了这一特点，因为用户的数据安全对我们是至关重要的。

所有和仓库相关的写入操作都是原子的，也就是说如果操作中断或者失败，仓库会回滚到操作之前的状态，不会对仓库数据造成任何影响。

仓库的管理是通过 ***所有仓库*** 视图来完成的，位置位于 ***侧栏菜单 --> 所有仓库***。

新建仓库
---------
#### 创建一个空的仓库
点击 ***新建仓库*** 按钮来打开新建仓库视图，输入仓库名称后点击 ***完成*** 即可，通过这种方式创建的仓库云同步开关默认是处于开启的状态，任何关于仓库的更新都会被自动同步到iCloud。

#### 克隆一个远程仓库
通过这个功能来克隆一个位于远程服务器上的仓库，点击 ***克隆仓库*** 按钮来打开克隆仓库视图，输入仓库的URL后，点击 ***完成*** 即可。通过这种方式创建的仓库云同步开关默认是处于开启的状态，任何关于仓库的更新都会被自动同步到iCloud。

如果远程仓库下载需要授权，则需要提供用户名和密码完成授权，才可继续下载仓库。

通过 ***任务视图（侧栏菜单 --> 任务）*** 还可以随时了解仓库克隆进度，或者直接取消未完成的仓库克隆。 

#### 从GitHub下载
除了上述两种方式外，我们在应用内部支持对GitHub上的仓库进行搜索，使您可以在应用内直接下载GitHub的仓库，从GitHub上下载的仓库云同步开关默认是关闭状态，如果需要同步这个仓库，则需要手动打开开关。

默认的情况下，仓库下载会在设备返回主屏幕或者进入其他应用后停止，但是如果在 ***服务器设置（侧栏菜单 --> 设置 --> 服务器）*** 中开启了后台运行模式，下载则会继续直到下载完成。

建议不要开启太多的下载，因为移动设备的处理能力有限，太多的下载可能会导致应用占用太多的资源，由此可能会导致GitDrive被系统强制退出。

仓库的删除
---------
在仓库视图上点击屏幕右上角的 ***编辑*** 按钮，列表切换到编辑状态，找到您需要删除的仓库，点击左边灰色的删除按钮即可。删除之前请确认目标仓库确实不再需要，因为这个操作同样会删除仓库在云中已经同步的副本，而且这些操作都是不可恢复的，一定要慎重哟！

如果这个被删除的仓库已经被同步到了其它的设备，那么在其它设备上的仓库是不会被自动删除的，它的云同步开关将会被自动关闭，以避免它再次被同步到云中。

仓库的设置
---------
在仓库视图上点击屏幕右上角的 ***编辑*** 按钮，列表切换到编辑状态，找到您需要修改设置的仓库，直接点击右边蓝色的删除按钮即可进入设置视图，在这里您可以修改和仓库相关的如下设置：
- 仓库名称
- 开启云同步
- 允许对仓库进行shallow更新
- 允许外部访问
- 开启访问授权

#### 开启云同步
开启这个开关后，仓库有任何的内容更新都会被自动同步到iCloud直到您关闭这个开关，关闭这个开关时会删除其在iCloud上已经同步的副本。

#### 允许对仓库进行shallow更新
如果您本地的仓库不是通过shallow方式克隆的，那么不会涉及到shallow更新这个操作，除非您本地仓库在克隆的时候加上 ***--depth*** 参数，那么可能会导致您的仓库是shallow的，如果您在将其push到GitDrive才会产生仓库shallow更新操作，默认这个选项是允许的。

#### 是否允许外部访问
关闭这个选项会导致仓库从外部无法访问。

#### 仓库的授权访问
如果您开启这个选项，那么对仓库的远程访问需要提供用户名和密码授权。

您需要为这个仓库在 ***用户管理*** 里面指定授权用户，如果仓库没有任何可用的授权用户，则会导致这个仓库无法从外部访问，开启授权访问后，点击下方的 ***用户管理*** 来选择允许访问仓库的用户。

云同步
---------
我们将iCloud作为GitDrive的云存储设备，通过iCloud，我们可以将仓库的任何变化同步到所有的设备上，我们建议您为重要的仓库开启云同步，以防止由于设备的损坏而导致数据的丢失。

仓库开启云同步之后，GitDrive会定期的将仓库的更新同步到iCloud，及您其它使用同样iCloud帐号的设备，每次同步都是增量的，我们会保证一个最小数据传输量。

但是有一种情况会导致您的仓库和云中的仓库产生冲突，考虑下面的场景：设备A的仓库C有一些更新尚未同步到云，设备B上的仓库C也有一些更新需要同步到云，如果两个设备同时同步的话，就会产生内容冲突。那么我们如何解决这些冲突呢？以设备A为例，如果它发现了来自设备B的这些冲突后，会尝试自动解决这些冲突，这些冲突的内容不会被存放到仓库C中，而是会新建一个仓库，新建的仓库会被命名为C_xxxxx，我们将仓库C称为主仓库，将仓库C_xxxxx称为子仓库，C_xxxxx则会用来存放来自于设备B的仓库C的更新内容。

如果您想手动解决这个冲突的话，可以将子仓库和主仓库都下载到本地，在本地创建另外一个仓库保存合并冲突后的内容，然后在GitDrive中删除主仓库，之后将刚才已经合并好的仓库上传到GitDrive即可。

每个仓库可能会有多个子仓库，这些子仓库不可以被单独删除，它们只可以跟随着主仓库一起被删除，子仓库的内容更新也同样会被同步到云。

关于仓库的标志
---------
如果您注意一下，会在仓库视图上发现仓库名称旁边会有一些不同样子的小图标，每个小图标都代表着不同的含义，了解这些含义，能够帮助您更好的管理仓库，下面就为您一一介绍这些图标的含义：
- ![](../image/icon_indicator_repository_new.png) 代表这是一个新建的仓库，还从未被访问过，如果您在仓库名字上点一下，那么这个图标会立即消失。
- ![](../image/icon_indicator_repository_auth.png) 如果出现这个标志，则意味着仓库已经开启了授权访问，远程访问需要提供用户名和密码。
- ![](../image/icon_indicator_repository_shallow.png) 如果出现这个标志，则代表这是一个shallow的仓库。
- ![](../image/icon_indicator_repository_locked.png) 如果出现这个标志，则代表当前仓库已经被锁定，被锁定的仓库无法进行写操作。
- ![](../image/icon_indicator_repository_need_backup.png) 如果出现这个标志，则意味着当前的仓库有些更新尚未同步到云，可能会有诸多原因造成内容没有及时同步，比如：您指定了仅在Wi-Fi环境同步，但是当前的网络环境不满足，又或者您还没有登录iCloud。
- ![](../image/icon_indicator_repository_new_content.png) 如果出现这个标志，则意味着这个仓库最近被更新过，您尚未查看这些更新，中间的数字代表共有多少次的更新未被查看。
- ![](../image/icon_indicator_repository_root.png) 如果出现这个标志，则意味着当前的仓库和iCloud存在内容冲突，这个是主仓库。
- ![](../image/icon_indicator_repository_child.png) 如果出现这个标志，则意味当前仓库是为了解决和iCloud内容冲突而自动创建的子仓库，它的作用主要用来保存和主仓库相冲突的内容。

关于仓库的锁定
---------
为了保证操作的原子性，应用在您对仓库进行任何操作之前都会将仓库进行锁定，在操作成功后进行解锁，如果操作失败则会将仓库回滚到操作之前的状态，但在极少的情况下，可能会导致操作回滚失败（例如：系统存储空间已满），在这种情况下，仓库会一直处于锁定的状态，在这个状态下的仓库是无法进行任何修改操作，仓库变成只读状态。

在这种情况下需要您手动解锁，如何手动解锁呢？很简单，只需将锁定的仓库先下载到本地，然后删除锁定的仓库，然后再将刚才下载到本地的仓库上传回来即可。

